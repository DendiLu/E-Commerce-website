<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>商品类目统计</title>
    <link rel="stylesheet" href="../css/index.css">
    <link rel="stylesheet" href="../plugins/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
<div id="app">
    <el-date-picker
            v-model="dateRange"
            type="daterange"
            @change="fetchData"
            range-separator="至"
            start-placeholder="开始日期"
            end-placeholder="结束日期">
    </el-date-picker>
    <HR>
    <br>
    <div id="chart" style="width: 1000px;height: 500px;"></div>
    <hr>
    <el-col span="4" style="padding-right: 30px;padding-left: 30px">
        <el-input v-model="reportDate" placeholder="报告日期"></el-input>
    </el-col>

    <el-button @click="generateReport" type="primary">立即生成报告</el-button>


    <hr>

    <el-table
            :data="tableData"
            border
            style="width: 80%">
        <el-table-column
                prop="categoryName"
                label="分类名称"
                >
        </el-table-column>
        <el-table-column
                prop="num"
                label="销售量"
                >
        </el-table-column>
        <el-table-column
                label="销售额">
            <template slot-scope="scope">
                {{(scope.row.money/100).toFixed(2)}}
            </template>
        </el-table-column>
        <el-table-column
                label="销售比例">
            <template slot-scope="scope">
                <span v-if="(scope.row.num/totalNum*100).toFixed(0)<1"><1%</span>
                <span v-else>{{(scope.row.num/totalNum*100).toFixed(0)}}%</span>
            </template>
        </el-table-column>
        <el-table-column
                label="金额比例">
            <template slot-scope="scope">
                <span v-if="(scope.row.money/totalMoney*100)<1"><1%</span>
                <span v-else>{{(scope.row.money/totalMoney*100).toFixed(0)}}%</span>
            </template>
        </el-table-column>

    </el-table>

</div>
</body>
<script src="/js/util.js"></script>
<script src="/js/vue.js"></script>
<script src="/js/axios.js"></script>
<script src="/js/elementui.js"></script>
<script src="/js/echarts.common.min.js"></script>
<script>
    new Vue({
        el: '#app',
        data() {
            return {
                tableData: [],
                dateRange: [],
                totalNum: 0,
                totalMoney: 0,
                reportDate: ""
            }
        },
        methods: {
            fetchData() {
                let date1 = this.dateRange[0].Format('yyyy-MM-dd');
                let date2 = this.dateRange[1].Format("yyyy-MM-dd");
                axios.get(`/categoryReport/category1Count.do?date1=${date1}&date2=${date2}`).then(response => {
                    this.tableData = response.data;
                    this.totalNum = 0;
                    this.totalMoney = 0;
                    for (let i = 0; i < this.tableData.length; i++) {
                        this.totalNum += this.tableData[i].num;
                        this.totalMoney += this.tableData[i].money;
                    }

                    let legendData = [];//图例
                    let numData = [];//销售量数据
                    let moneyData = [];
                    for (let i = 0; i < this.tableData.length; i++) {
                        legendData.push(this.tableData[i].categoryName);
                        numData.push({name: this.tableData[i].categoryName, value: this.tableData[i].num});
                        moneyData.push({name: this.tableData[i].categoryName, value: this.tableData[i].money});
                    }
                    let myChart = echarts.init(document.getElementById('chart'));
                    let option = {
                        title: {
                            text: '商品销售类目分析',
                            left: 'center'
                        },
                        tooltip: {
                            //item:数据项图形触发，主要在散点图，饼图等无类目轴的图表中使用。
                            trigger: 'item',
                            //饼图、仪表盘、漏斗图: {a}（系列名称），{b}（数据项名称），{c}（数值）, {d}（百分比）
                            formatter: '{a} <br/>{b} : {c} ({d}%)'
                        },
                        legend: {
                            orient: 'vertical',
                            left: 'left',
                            data: legendData
                        },
                        series: [
                            {
                                name: '销售数量',
                                type: 'pie',
                                radius: '45%',
                                center: ['30%', '50%'],
                                data: numData,
                                emphasis: {
                                    itemStyle: {
                                        shadowBlur: 10,
                                        shadowOffsetX: 0,
                                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                                    }
                                }
                            },
                            {
                                name: '销售金额',
                                title: '销售金额',
                                type: 'pie',
                                radius: '45%',
                                center: ['75%', '50%'],
                                data: moneyData,
                                emphasis: {
                                    itemStyle: {
                                        shadowBlur: 10,
                                        shadowOffsetX: 0,
                                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                                    }
                                }
                            }
                        ]
                    };
                    myChart.setOption(option);

                });
            },
            generateReport() {
                axios.get(`/categoryReport/generateReport.do?date=${this.reportDate}`).then(response => {
                    alert("生成成功！");
                })
            }
        }
    })
</script>
</html>